# 0024 â€” Harmonious SVG Compatibility Foundation

> Dependencies: 0020 (C ABI), 0022 (testing), 0023 (WASM demo)
> Blocks: 0025, 0026, 0027

## Objective

Build the compatibility infrastructure required to generate and verify harmoniousapp.net SVGs by kind, with deterministic API-driven filename/argument production and a WASM-hosted validation page.

## Research Phase

### 1. Source Mapping

- Audit `tmp/harmoniousapp.net/js-client/*.js` for URL/image generation and naming conventions.
- Inventory filename grammars for each requested kind:
  - `vert-text-black`, `vert-text-b2t-black`, `center-square-text`
  - `even`, `opc`, `optc`, `oc`
  - `scale`, `chord`, `chord-clipped`, `wide-chord`, `grand-chord`
  - `eadgbe`, `majmin`
- Identify kinds where current C/WASM exports are missing generation entry points.

### 2. API Gap Analysis

- Document existing SVG exports (`lmt_svg_clock_optc`, `lmt_svg_fret`, `lmt_svg_chord_staff`) vs required kinds.
- Define a compatibility API that can:
  - enumerate kinds,
  - enumerate image names per kind,
  - generate SVG for a kind/name pair.

### 3. Verification Model

- Define exact-byte comparison strategy against `tmp/harmoniousapp.net/<kind>/*.svg`.
- Define conditional execution: compatibility tests run only when `tmp/harmoniousapp.net/` exists.

## Implementation Steps

### 1. Compatibility API Surface

- Add C ABI exports for compatibility enumeration/generation.
- Ensure image names and generation arguments are produced from library API methods (no hardcoded JS logic in validation frontend).

### 2. Test Harness

- Add `src/tests/svg_harmonious_compat_test.zig`.
- Add exact-match assertions (byte-for-byte).
- Gate test execution on local dataset presence.

### 3. WASM Validation Page

- Add `examples/wasm-demo/validation.html` (+ JS/CSS as needed).
- Page must call compatibility APIs and generate all listed images programmatically via WASM.
- Page must include per-kind status and mismatch visibility.

### 4. Verification Integration

- Update `./verify.sh` to run new compatibility checks when dataset exists.
- Keep default repo verification passing when dataset is absent.

## Exit Criteria

- `./verify.sh` passes
- `zig build verify` passes
- Compatibility test framework exists and runs conditionally
- WASM validation page can enumerate and generate all configured compatibility kinds through WASM exports

## Verification Data Sources

- `tmp/harmoniousapp.net/js-client/*.js`
- `tmp/harmoniousapp.net/<kind>/*.svg`

## Kind Progress Rule

A kind may only be marked complete when:
1. all files in `tmp/harmoniousapp.net/<kind>/` are generated by library APIs,
2. all generated SVG bytes exactly match reference files,
3. the kind is included in `validation.html` generation and verification output.

## Implementation History (Point-in-Time)

- Commit: `0fff14eee024ea3dbce6ae8bf90243b49ed0eca3`
- Date: `2026-02-18 03:42:47 +0100`
- Shipped behavior:
- Added compatibility manifest-driven API (`kind`/`directory`/`image` enumeration + generation) through Zig and C ABI.
- Added compatibility test harness at `src/tests/svg_harmonious_compat_test.zig` with strict opt-in byte matching when references are present.
- Added WASM validation surface (`examples/wasm-demo/validation.html`, `examples/wasm-demo/validation.js`) to generate all kinds from WASM APIs and report per-kind parity.
- Completion gates:
- `./verify.sh`
- `zig build verify`
