# 0020 — C ABI Wrapper

> Dependencies: ALL previous plans (0002-0019)
> Blocks: None (final integration layer)

## Objective

Create a stable C ABI interface (`libmusictheory.h` + `libmusictheory.a`/`.so`/`.dylib`) that exposes all library functionality to any language via C FFI.

## Research References

- All algorithm and data structure research documents

## Implementation Steps

### 1. C Header Generation (`include/libmusictheory.h`)

Define C-compatible types:
```c
typedef uint16_t lmt_pitch_class_set;  // u12 stored in u16
typedef uint8_t lmt_pitch_class;       // u4 stored in u8
typedef uint8_t lmt_midi_note;         // u7 stored in u8
typedef uint8_t lmt_interval;
typedef uint8_t lmt_interval_class;
```

### 2. Function Categories

**Pitch Class Set Operations:**
```c
lmt_pitch_class_set lmt_pcs_from_list(const lmt_pitch_class* pcs, uint8_t count);
uint8_t lmt_pcs_to_list(lmt_pitch_class_set set, lmt_pitch_class* out);
uint8_t lmt_pcs_cardinality(lmt_pitch_class_set set);
lmt_pitch_class_set lmt_pcs_transpose(lmt_pitch_class_set set, uint8_t semitones);
lmt_pitch_class_set lmt_pcs_invert(lmt_pitch_class_set set);
lmt_pitch_class_set lmt_pcs_complement(lmt_pitch_class_set set);
bool lmt_pcs_is_subset(lmt_pitch_class_set small, lmt_pitch_class_set big);
```

**Set Classification:**
```c
lmt_pitch_class_set lmt_prime_form(lmt_pitch_class_set set);
lmt_pitch_class_set lmt_forte_prime(lmt_pitch_class_set set);
bool lmt_is_cluster_free(lmt_pitch_class_set set);
float lmt_evenness_distance(lmt_pitch_class_set set);
```

**Scales/Modes/Keys:**
```c
lmt_pitch_class_set lmt_scale(lmt_scale_type type, lmt_pitch_class tonic);
lmt_pitch_class_set lmt_mode(lmt_mode_type type, lmt_pitch_class root);
const char* lmt_spell_note(lmt_pitch_class pc, lmt_key_context key);
```

**Chords:**
```c
lmt_pitch_class_set lmt_chord(lmt_chord_type type, lmt_pitch_class root);
const char* lmt_chord_name(lmt_pitch_class_set set);
const char* lmt_roman_numeral(lmt_pitch_class_set chord, lmt_key_context key);
```

**Guitar:**
```c
lmt_midi_note lmt_fret_to_midi(uint8_t string, uint8_t fret, const uint8_t* tuning);
uint8_t lmt_midi_to_fret_positions(lmt_midi_note note, const uint8_t* tuning, lmt_fret_pos* out);
```

**SVG Generation:**
```c
uint32_t lmt_svg_clock_optc(lmt_pitch_class_set set, char* buf, uint32_t buf_size);
uint32_t lmt_svg_fret(const int8_t* frets, char* buf, uint32_t buf_size);
uint32_t lmt_svg_chord_staff(lmt_chord_type type, lmt_pitch_class root, char* buf, uint32_t buf_size);
```

### 3. Zig Export Functions (`src/c_api.zig`)

Use `export` keyword for C-callable functions:
```zig
export fn lmt_pcs_cardinality(set: u16) callconv(.C) u8 {
    return @popCount(@as(u12, @intCast(set & 0xFFF)));
}
```

### 4. Build Configuration (`build.zig`)

- Static library: `libmusictheory.a`
- Shared library: `libmusictheory.so` / `.dylib`
- Install header to `include/`
- Cross-compilation targets

### 5. Language Binding Examples

- C example: `examples/c/`
- Python (ctypes): `examples/python/`

### 6. Tests

- Call every exported function from C
- Verify ABI stability (struct layouts, enum values)
- Memory safety: no allocations leaked across FFI boundary

## Verification Protocol

Before implementing any step in this plan:
1. Read `CONSTRAINTS.md` in full.
2. Update `./verify.sh` so the target behavior is checked programmatically.
3. Run `./verify.sh` as baseline (must pass before changes).
4. Write tests first when feasible (red → green flow).
5. Implement the change.
6. Run `./verify.sh` again — do not declare success unless it passes.

## Exit Criteria

- `./verify.sh` passes
- `zig build verify` passes
- Every exported function callable from C test harness
- Struct layouts stable (verified by `sizeof`/`offsetof` assertions)
- No memory leaks across FFI boundary
- Static and shared libraries both build and link

## Verification Data Sources

- **music21** — Forte numbers via C API
- **tonal-ts** — chord/scale verification via C API
- **harmoniousapp.net** — algorithm correctness via C API

## Implementation History (Point-in-Time)

- `25280b9` (2026-02-16):
  - Shipped behavior: added `src/c_api.zig` C ABI exports, `include/libmusictheory.h`, C/Python examples, C smoke harness (`examples/c/smoke.c`) linked against static/shared artifacts, and Zig ABI tests (`src/tests/c_api_test.zig`) with header layout checks.
  - Verification: `./verify.sh` passes, `zig build verify` passes.

## Estimated Scope

- ~300 lines of C header
- ~400 lines of Zig export wrappers
- ~200 lines of tests
- ~100 lines of build.zig additions
