# Staff Notation (Chord and Scale SVGs)

> References: [Pitch and Intervals](../pitch-and-intervals.md)
> Source directories: `tmp/harmoniousapp.net/chord/` (1,698 SVGs), `tmp/harmoniousapp.net/grand-chord/` (2,032 SVGs), `tmp/harmoniousapp.net/scale/` (494 SVGs)
> Generated by: VexFlow JavaScript music notation library

## Overview

Staff notation SVGs show musical notes on traditional 5-line staves. Three types:
1. **chord/**: Single treble clef chord notation (170√ó110.77 px)
2. **grand-chord/**: Grand staff chord notation with treble + bass (170√ó216 px)
3. **scale/**: Horizontal scale notation on treble clef (363√ó113 px)

## SVG Specifications

### Treble Clef Chord (`tmp/harmoniousapp.net/chord/`)
- **Canvas**: 170 √ó 110.77 px viewBox
- **Content**: Treble clef + key signature + single chord (notes stacked vertically)
- **Elements**: Clef glyph, staff lines, noteheads, stems, accidentals, ledger lines
- **All paths**: Text rendered as SVG `<path>` elements (from font outlines) for font-independence

### Grand Staff Chord (`tmp/harmoniousapp.net/grand-chord/`)
- **Canvas**: 170 √ó 216 px viewBox
- **Content**: Treble clef + bass clef connected by brace, key signature on both, chord split across staves
- **Split rule**: Notes at/above MIDI 60 (middle C) ‚Üí treble clef; below ‚Üí bass clef
- **Connecting**: Brace on left side, barline connecting both staves

### Scale Notation (`tmp/harmoniousapp.net/scale/`)
- **Canvas**: 363 √ó 113 px viewBox
- **Content**: Treble clef + key signature + sequence of noteheads (one per scale degree)
- **Layout**: Notes flow left to right, ascending pitch
- **Duration**: All notes rendered as whole notes (no rhythm)

## Generation Algorithm (VexFlow-based)

### Step 1: MIDI Notes to Staff Positions

```
TREBLE_CLEF_LINES = [64, 67, 71, 74, 77]  // E4 G4 B4 D5 F5
BASS_CLEF_LINES = [43, 47, 50, 53, 57]    // G2 B2 D3 F3 A3

staff_position(midi, clef):
    if clef == TREBLE:
        // Middle line (B4 = MIDI 71) is position 0
        // Each step up = one line or space
        semitone_to_position = ... // maps MIDI to vertical position
    elif clef == BASS:
        // Middle line (D3 = MIDI 50) is position 0
```

### Step 2: Determine Accidentals from Key Context

```
needs_accidental(note_pc, key_signature):
    // Check if the note's pitch class is already covered by the key signature
    // If not, it needs an explicit accidental
    natural_pcs = key_signature.diatonic_pitch_classes()
    if note_pc in natural_pcs:
        return NONE
    // Determine sharp or flat based on key context
    return compute_accidental(note_pc, key_signature)
```

### Step 3: Layout Computation

```
layout_chord(midi_notes, key_sig):
    // Sort notes low to high
    sorted = sort(midi_notes)
    // Check for seconds (adjacent notes) ‚Äî need offset noteheads
    for i in 1..len(sorted):
        if sorted[i] - sorted[i-1] <= 2:
            // Offset notehead to right to avoid collision
            offset[i] = true
    // Determine stem direction (majority rule or default up)
    avg_position = mean(staff_positions)
    stem_direction = if avg_position > middle_line then DOWN else UP
```

### Step 4: SVG Path Generation

VexFlow converts music notation to SVG paths. The key elements:
- **Noteheads**: filled oval paths at computed staff positions
- **Stems**: vertical lines from noteheads
- **Accidentals**: sharp (‚ôØ), flat (‚ô≠), natural (‚ôÆ) glyphs positioned left of noteheads
- **Ledger lines**: short horizontal lines for notes above/below the staff
- **Clef**: treble (ùÑû) or bass (ùÑ¢) glyph paths from music font
- **Key signature**: accidentals at standard positions after clef
- **Staff lines**: 5 horizontal lines

### Step 5: Font Path Rendering

All text in the site's SVGs is rendered as `<path>` elements derived from two font families:
- **Fira Sans**: for labels, note names, annotations
- **Merriweather**: for serif text in articles (multiple optical sizes)

This ensures font-independent rendering. Paths are extracted from WOFF font files and embedded directly.

## File Naming Convention

### tmp/harmoniousapp.net/chord/
`tmp/harmoniousapp.net/chord/{root}-{chord_type}.svg`
Example: `tmp/harmoniousapp.net/chord/C-Major-7th.svg`, `tmp/harmoniousapp.net/chord/F-sharp-Minor.svg`

### tmp/harmoniousapp.net/grand-chord/
`tmp/harmoniousapp.net/grand-chord/{root}-{chord_type}.svg`
Same naming as tmp/harmoniousapp.net/chord/ but with grand staff rendering.

### tmp/harmoniousapp.net/scale/
`tmp/harmoniousapp.net/scale/{root}-{scale_type}-{mode}.svg`
Example: `tmp/harmoniousapp.net/scale/C-Major.svg`, `tmp/harmoniousapp.net/scale/D-Dorian.svg`

## Counts
- tmp/harmoniousapp.net/chord/: 1,698 SVGs (‚âà100 chord types √ó 12 roots, with some extras)
- tmp/harmoniousapp.net/grand-chord/: 2,032 SVGs (more chord types including extended/altered)
- tmp/harmoniousapp.net/scale/: 494 SVGs (‚âà7 scale types √ó modes √ó some roots)

## Algorithm Dependencies
- [Note Spelling](../algorithms/note-spelling.md): correct accidental choice per key context
- [Chord Construction](../algorithms/chord-construction-and-naming.md): MIDI notes from chord type + root
- [Scale, Mode, Key](../algorithms/scale-mode-key.md): scale note sequences

## Scale Compat Notes (2026-02-18)

- Compatibility API argument enumeration is the canonical source for `scale/*.svg`; validation does not infer names by parsing SVG.
- Key signature accidentals are rendered algorithmically by translating reusable sharp/flat glyph path data to the canonical anchor grid.
- Scale note x-placement uses deterministic spacing from:
- key-signature start x
- modifier collision offsets (`0/10/12/16`)
- normalized gap to right boundary (`x=355`).
- Exact byte parity currently requires deterministic ULP adjustments for a subset of floating-point edge cases; these are small and bounded but remain an in-progress area for fully formula-only parity.
- Guardrails in `verify.sh` block old replay dependencies for scale layout (`by-index x`, `profile tuning`, `name lookup`, and pre-rendered key-signature lines).

## Interactivity (Future)
- Hover over noteheads to hear individual pitches
- Click to toggle notes on/off
- Real-time synchronization with clock diagram and keyboard views
- Responsive stem direction and accidental placement

## Zig Library Responsibility
The Zig library provides:
1. Correct MIDI notes for any chord/scale
2. Staff position computation (which line/space, which clef)
3. Accidental determination from key context
4. Ledger line requirements
5. Layout collision detection (second intervals)

SVG path rendering of music font glyphs (noteheads, clefs, accidentals) will use embedded glyph outlines ‚Äî either extracted from SMuFL-compliant fonts or generated procedurally.
